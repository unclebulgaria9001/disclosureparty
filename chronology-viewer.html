<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json?v=20260103">
    <meta name="theme-color" content="#58a6ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>UAP/UFO/NHI Chronology Viewer</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Comprehensive chronology of UAP/UFO disclosure events, NHI encounters, congressional hearings, and FOIA releases. Interactive timeline in multiple languages.">
    <meta name="keywords" content="UAP chronology, UFO timeline, disclosure events, NHI encounters, congressional hearings, FOIA">
    <meta name="robots" content="index, follow">
    
    <!-- Multilingual hreflang tags -->
    <link rel="alternate" hreflang="en" href="https://unclebulgaria9001.github.io/disclosureparty/chronology-viewer.html">
    <link rel="alternate" hreflang="x-default" href="https://unclebulgaria9001.github.io/disclosureparty/chronology-viewer.html">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="css/shared-styles.css">
    <link rel="stylesheet" href="i18n/language-switcher.css">
    <script src="i18n/translations.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation will be injected here -->
        <div id="header"></div>
        
        <div id="languageSwitcherContainer"></div>
        
        <!-- Search bar will be injected here -->
        <div id="searchBarContainer"></div>
        
        <button class="toggle-sidebar" id="toggleSidebar" data-i18n="filters">‚ò∞ FILTERS</button>
        
        <div class="main-layout">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="color: #a0a0a0; font-size: 0.85em;">
                            <span id="eventCount">Loading events...</span>
                        </div>
                    </div>
                    
                    <!-- Period Filters -->
                    <div class="filter-section">
                        <div class="filter-section-title" data-i18n="timePeriodFilters">TIME PERIOD FILTERS</div>
                        <div id="periodFilters" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="filter-btn" style="flex: 1;" onclick="selectAllPeriods()" data-i18n="selectAll">ALL</button>
                            <button class="filter-btn" style="flex: 1;" onclick="deselectAllPeriods()" data-i18n="deselectAll">NONE</button>
                        </div>
                    </div>
                    
                    <!-- Category Filters -->
                    <div class="filter-section">
                        <div class="filter-section-title">CATEGORY TAGS</div>
                        <div id="categoryFilters" style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.85em;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="filter-btn" style="flex: 1;" onclick="selectAllCategories()">ALL</button>
                            <button class="filter-btn" style="flex: 1;" onclick="deselectAllCategories()">NONE</button>
                        </div>
                    </div>
                    
                    <!-- Geographic Filters -->
                    <div class="filter-section">
                        <div class="filter-section-title">GEOGRAPHIC REGIONS</div>
                        <div id="geoFilters" style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.85em;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="filter-btn" style="flex: 1;" onclick="selectAllGeo()">ALL</button>
                            <button class="filter-btn" style="flex: 1;" onclick="deselectAllGeo()">NONE</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-container">
                <!-- Results Header -->
                <div class="results-header">
                    <div class="results-info">
                        <div class="result-count" id="resultCount">Loading...</div>
                        <div class="result-stats" id="resultStats"></div>
                    </div>
                    <div class="sort-options">
                        <label>Sort:</label>
                        <select id="sortBy">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="relevance">Relevance</option>
                        </select>
                    </div>
                </div>
                
                <div class="timeline" id="timeline">
                    <div class="loading">Loading chronology data...</div>
                </div>
                
                <footer>
                    <p>For content suggestions: <a href="https://github.com/unclebulgaria9001/disclosureparty/issues/new?template=new-event.md">Submit via GitHub Issues</a></p>
                </footer>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import shared services
        import { chronologyService } from './js/services/chronology-service.js';
        import { filterService } from './js/services/filter-service.js';
        import { searchService } from './js/services/search-service.js';
        import { URLParamsManager } from './js/utils/url-params.js';
        import { escapeHtml, showNotification } from './js/utils/helpers.js';
        
        // Filter presets
        const FILTER_PRESETS = {
            'recent-hearings': {
                name: 'üìã Recent Hearings',
                periods: ['2024', '2025', '2026'],
                categories: ['CongressionalHearings'],
                geo: ['USA']
            },
            'military-encounters': {
                name: '‚úàÔ∏è Military Encounters',
                categories: ['MilitaryEncounters'],
                geo: ['USA', 'Europe', 'Asia']
            },
            'historical-sightings': {
                name: 'üìú Historical Events',
                periods: ['194', '195', '196', '197'],
                categories: ['CivilianSightings', 'MilitaryEncounters']
            },
            'whistleblower-disclosures': {
                name: 'üîì Disclosures & FOIA',
                categories: ['WhistleblowerDisclosures', 'LeaksDeclass']
            },
            'international': {
                name: 'üåç International',
                geo: ['Europe', 'Asia', 'LatinAmerica', 'International']
            }
        };
        
        const PERIODS = ['2030', '2029', '2028', '2027', '2026', '2025', '2024', '2023', '2022', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011', '2010', '200', '199', '198', '197', '196', '195', '194', '18', 'ancient'];
        const CATEGORIES = ['Outbound', 'Inbound', 'ContactAttempt', 'LegislationPolicy', 'CongressionalHearings', 'LeaksDeclass', 'WhistleblowerDisclosures', 'MilitaryEncounters', 'CivilianSightings', 'AbductionCEIII', 'CrashRetrievals', 'UnderwaterUSO', 'SpaceSatellite', 'ScientificStudies', 'HistoricalPreModern', 'ReligiousCultural'];
        const GEO_TAGS = ['USA', 'Canada', 'Mexico', 'Europe', 'UnitedKingdom', 'LatinAmerica', 'Asia', 'MiddleEast', 'Africa', 'Oceania', 'International', 'Space'];
        
        let currentSort = 'date-desc';
        
        // Initialize navigation
        document.getElementById('header').innerHTML = `
            <header class="main-header">
                <h1>UAP/UFO/NHI DISCLOSURE DATABASE</h1>
                <p class="subtitle">Comprehensive Chronology Viewer</p>
                <nav class="nav-links">
                    <a href="index.html">üè† Home</a>
                    <a href="chronology-viewer.html" class="active">üìã Chronology</a>
                    <a href="timeline.html">üìä Timeline</a>
                    <a href="dist/chronology.md" target="_blank">üìÑ Raw Data</a>
                    <a href="https://github.com/unclebulgaria9001/disclosureparty" target="_blank">üíª GitHub</a>
                </nav>
            </header>
        `;
        
        // Initialize search bar with presets
        document.getElementById('searchBarContainer').innerHTML = `
            <div class="search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-box" id="searchInput" 
                               placeholder="Search events, dates, locations, people..." 
                               autocomplete="off">
                        <button class="clear-search" id="clearSearch" title="Clear search">√ó</button>
                    </div>
                    <div class="quick-filters">
                        ${Object.entries(FILTER_PRESETS).map(([id, preset]) => `
                            <button class="preset-btn" data-preset="${id}">${preset.name}</button>
                        `).join('')}
                    </div>
                    <div class="active-filters" id="activeFilters"></div>
                </div>
            </div>
        `;
        
        // Populate filter checkboxes
        function populateFilters() {
            const counts = filterService.calculateCounts();
            
            // Period filters
            document.getElementById('periodFilters').innerHTML = PERIODS.map(period => {
                const label = period === 'ancient' ? 'Ancient' : period.length === 4 ? period : period.length === 3 ? period + '0s' : period + '00s';
                const count = counts.periods[period] || 0;
                return `
                    <label style="display: inline-flex; align-items: center; gap: 6px; color: #e0e0e0; cursor: pointer;">
                        <input type="checkbox" class="period-filter" value="${period}" checked>
                        <span>${label} <span class="period-count">(${count})</span></span>
                    </label>
                `;
            }).join('');
            
            // Category filters
            document.getElementById('categoryFilters').innerHTML = CATEGORIES.map(cat => {
                const count = counts.tags[cat] || 0;
                const shortName = cat.replace('CongressionalHearings', 'Hearings').replace('LegislationPolicy', 'Legislation').replace('WhistleblowerDisclosures', 'Whistleblower').replace('MilitaryEncounters', 'Military').replace('CivilianSightings', 'Civilian').replace('ContactAttempt', 'Contact').replace('LeaksDeclass', 'Leaks/FOIA').replace('AbductionCEIII', 'Abduction').replace('CrashRetrievals', 'Crash').replace('UnderwaterUSO', 'USO').replace('SpaceSatellite', 'Space').replace('ScientificStudies', 'Scientific').replace('HistoricalPreModern', 'Historical').replace('ReligiousCultural', 'Religious');
                return `
                    <label style="display: inline-flex; align-items: center; gap: 4px; color: #e0e0e0; cursor: pointer;">
                        <input type="checkbox" class="category-filter" value="${cat}" checked>
                        <span>${shortName} <span class="tag-count">(${count})</span></span>
                    </label>
                `;
            }).join('');
            
            // Geo filters
            document.getElementById('geoFilters').innerHTML = GEO_TAGS.map(geo => {
                const count = counts.tags[geo] || 0;
                return `
                    <label style="display: inline-flex; align-items: center; gap: 4px; color: #e0e0e0; cursor: pointer;">
                        <input type="checkbox" class="geo-filter" value="${geo}" checked>
                        <span>${geo} <span class="tag-count">(${count})</span></span>
                    </label>
                `;
            }).join('');
            
            // Attach change events
            document.querySelectorAll('.period-filter, .category-filter, .geo-filter').forEach(cb => {
                cb.addEventListener('change', applyFilters);
            });
        }
        
        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value;
            const selectedPeriods = Array.from(document.querySelectorAll('.period-filter:checked')).map(cb => cb.value);
            const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
            const selectedGeo = Array.from(document.querySelectorAll('.geo-filter:checked')).map(cb => cb.value);
            
            filterService.setSearch(searchTerm);
            filterService.setPeriods(selectedPeriods);
            filterService.setCategories(selectedCategories);
            filterService.setGeo(selectedGeo);
        }
        
        // Render timeline
        function renderTimeline(entries) {
            const timeline = document.getElementById('timeline');
            const searchTerm = searchService.getSearchTerm();
            
            if (entries.length === 0) {
                timeline.innerHTML = '<div class="loading">No entries found matching your filters.</div>';
                return;
            }
            
            timeline.innerHTML = entries.map(entry => `
                <div class="entry">
                    <div class="entry-date">${searchService.highlightSearchTerm(entry.date)}</div>
                    <div class="entry-title">${searchService.highlightSearchTerm(entry.title)}</div>
                    ${entry.content ? `<div class="entry-content">${searchService.highlightSearchTerm(entry.content)}</div>` : ''}
                    ${entry.tags.length > 0 ? `<div>${entry.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
                    ${entry.links.length > 0 ? `
                        <div class="entry-links">
                            ${entry.links.map(link => `<a href="${escapeHtml(link)}" target="_blank">${escapeHtml(link)}</a>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Update stats
        function updateStats(data) {
            const resultCount = document.getElementById('resultCount');
            const resultStats = document.getElementById('resultStats');
            const eventCount = document.getElementById('eventCount');
            
            resultCount.textContent = `Showing ${data.filtered.length} of ${data.total} events`;
            eventCount.textContent = `${data.total} total events`;
            
            if (data.filtered.length > 0) {
                const years = data.filtered.map(e => e.year).filter(y => y > 0);
                const minYear = Math.min(...years);
                const maxYear = Math.max(...years);
                resultStats.textContent = `üìÖ ${minYear} - ${maxYear}`;
            } else {
                resultStats.textContent = '';
            }
        }
        
        // Update active filter badges
        function updateActiveFilters(activeFilters) {
            const container = document.getElementById('activeFilters');
            const badges = [];
            
            if (activeFilters.search) {
                badges.push(`<span class="filter-badge">üîç "${activeFilters.search}" <button onclick="clearSearch()">√ó</button></span>`);
            }
            
            const totalPeriods = PERIODS.length;
            const totalCategories = CATEGORIES.length;
            const totalGeo = GEO_TAGS.length;
            
            if (activeFilters.periods.length > 0 && activeFilters.periods.length < totalPeriods) {
                activeFilters.periods.slice(0, 3).forEach(p => {
                    const label = p === 'ancient' ? 'Ancient' : p.length === 4 ? p : p + '0s';
                    badges.push(`<span class="filter-badge">üìÖ ${label} <button onclick="removePeriod('${p}')">√ó</button></span>`);
                });
                if (activeFilters.periods.length > 3) {
                    badges.push(`<span class="filter-badge">+${activeFilters.periods.length - 3} more</span>`);
                }
            }
            
            if (activeFilters.categories.length > 0 && activeFilters.categories.length < totalCategories) {
                activeFilters.categories.slice(0, 3).forEach(c => {
                    badges.push(`<span class="filter-badge">üè∑Ô∏è ${c} <button onclick="removeCategory('${c}')">√ó</button></span>`);
                });
                if (activeFilters.categories.length > 3) {
                    badges.push(`<span class="filter-badge">+${activeFilters.categories.length - 3} more</span>`);
                }
            }
            
            if (activeFilters.geo.length > 0 && activeFilters.geo.length < totalGeo) {
                activeFilters.geo.slice(0, 3).forEach(g => {
                    badges.push(`<span class="filter-badge">üåç ${g} <button onclick="removeGeo('${g}')">√ó</button></span>`);
                });
                if (activeFilters.geo.length > 3) {
                    badges.push(`<span class="filter-badge">+${activeFilters.geo.length - 3} more</span>`);
                }
            }
            
            if (badges.length > 0) {
                badges.push(`<button class="clear-all-btn" onclick="clearAllFilters()">Clear All</button>`);
            }
            
            container.innerHTML = badges.join('');
        }
        
        // Sort entries
        function sortEntries(entries) {
            const sorted = [...entries];
            if (currentSort === 'date-desc') {
                sorted.sort((a, b) => b.year - a.year);
            } else if (currentSort === 'date-asc') {
                sorted.sort((a, b) => a.year - b.year);
            } else if (currentSort === 'relevance') {
                searchService.sortByRelevance(sorted);
            }
            return sorted;
        }
        
        // Global functions for buttons
        window.selectAllPeriods = () => {
            document.querySelectorAll('.period-filter').forEach(cb => cb.checked = true);
            applyFilters();
        };
        
        window.deselectAllPeriods = () => {
            document.querySelectorAll('.period-filter').forEach(cb => cb.checked = false);
            applyFilters();
        };
        
        window.selectAllCategories = () => {
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = true);
            applyFilters();
        };
        
        window.deselectAllCategories = () => {
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
            applyFilters();
        };
        
        window.selectAllGeo = () => {
            document.querySelectorAll('.geo-filter').forEach(cb => cb.checked = true);
            applyFilters();
        };
        
        window.deselectAllGeo = () => {
            document.querySelectorAll('.geo-filter').forEach(cb => cb.checked = false);
            applyFilters();
        };
        
        window.clearSearch = () => {
            document.getElementById('searchInput').value = '';
            searchService.clear();
            applyFilters();
        };
        
        window.removePeriod = (period) => {
            const cb = document.querySelector(`.period-filter[value="${period}"]`);
            if (cb) {
                cb.checked = false;
                applyFilters();
            }
        };
        
        window.removeCategory = (category) => {
            const cb = document.querySelector(`.category-filter[value="${category}"]`);
            if (cb) {
                cb.checked = false;
                applyFilters();
            }
        };
        
        window.removeGeo = (geo) => {
            const cb = document.querySelector(`.geo-filter[value="${geo}"]`);
            if (cb) {
                cb.checked = false;
                applyFilters();
            }
        };
        
        window.clearAllFilters = () => {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.period-filter, .category-filter, .geo-filter').forEach(cb => cb.checked = true);
            searchService.clear();
            applyFilters();
        };
        
        window.toggleSidebar = (event) => {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('chronologySidebarCollapsed', sidebar.classList.contains('collapsed'));
        };
        
        // Initialize
        async function init() {
            try {
                // Load chronology data
                const entries = await chronologyService.loadChronology();
                filterService.setAllEntries(entries);
                
                // Populate filters
                populateFilters();
                
                // Subscribe to filter changes
                filterService.subscribe((data) => {
                    const sorted = sortEntries(data.filtered);
                    renderTimeline(sorted);
                    updateStats(data);
                    updateActiveFilters(data.active);
                    URLParamsManager.saveToURL(data.active);
                });
                
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    searchService.setSearchTerm(e.target.value);
                    applyFilters();
                    document.getElementById('clearSearch').style.display = e.target.value ? 'block' : 'none';
                });
                
                document.getElementById('clearSearch').addEventListener('click', clearSearch);
                
                // Preset buttons
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const presetId = btn.dataset.preset;
                        const preset = FILTER_PRESETS[presetId];
                        
                        // Apply preset
                        document.querySelectorAll('.period-filter').forEach(cb => {
                            cb.checked = !preset.periods || preset.periods.includes(cb.value);
                        });
                        document.querySelectorAll('.category-filter').forEach(cb => {
                            cb.checked = !preset.categories || preset.categories.includes(cb.value);
                        });
                        document.querySelectorAll('.geo-filter').forEach(cb => {
                            cb.checked = !preset.geo || preset.geo.includes(cb.value);
                        });
                        
                        applyFilters();
                        showNotification(`Applied: ${preset.name}`);
                    });
                });
                
                // Sort dropdown
                document.getElementById('sortBy').addEventListener('change', (e) => {
                    currentSort = e.target.value;
                    const data = {
                        filtered: sortEntries(filterService.getFilteredEntries()),
                        active: filterService.getActiveFilters(),
                        total: chronologyService.getAllEntries().length
                    };
                    renderTimeline(data.filtered);
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                    }
                    if (e.key === 'Escape' && document.activeElement.id === 'searchInput') {
                        clearSearch();
                    }
                });
                
                // Restore sidebar state
                const isCollapsed = localStorage.getItem('chronologySidebarCollapsed') === 'true';
                if (isCollapsed) {
                    document.getElementById('sidebar').classList.add('collapsed');
                }
                
                // Load filters from URL
                const urlFilters = URLParamsManager.loadFromURL();
                if (urlFilters.search) {
                    document.getElementById('searchInput').value = urlFilters.search;
                    searchService.setSearchTerm(urlFilters.search);
                }
                if (urlFilters.periods) {
                    document.querySelectorAll('.period-filter').forEach(cb => {
                        cb.checked = urlFilters.periods.includes(cb.value);
                    });
                }
                if (urlFilters.categories) {
                    document.querySelectorAll('.category-filter').forEach(cb => {
                        cb.checked = urlFilters.categories.map(c => c.toLowerCase()).includes(cb.value.toLowerCase());
                    });
                }
                if (urlFilters.geo) {
                    document.querySelectorAll('.geo-filter').forEach(cb => {
                        cb.checked = urlFilters.geo.map(g => g.toLowerCase()).includes(cb.value.toLowerCase());
                    });
                }
                if (urlFilters.sort) {
                    currentSort = urlFilters.sort;
                    document.getElementById('sortBy').value = urlFilters.sort;
                }
                
                // Initial filter application
                applyFilters();
                
                // Initialize language switcher
                document.getElementById('languageSwitcherContainer').innerHTML = createLanguageSwitcher();
                updatePageLanguage();
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('timeline').innerHTML = '<div class="loading" style="color: #ff6b6b;">Error loading chronology. Please refresh the page.</div>';
            }
        }
        
        // Start initialization
        init();
    </script>
</body>
</html>
