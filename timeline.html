<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAP/UFO/NHI Chronology Timeline | Disclosure Database</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interactive timeline visualization of UAP/UFO sightings, NHI encounters, and Earth's communication attempts with non-human intelligence">
    <meta name="keywords" content="UAP timeline, NHI communication, Arecibo message, crop circles, interstellar messages, UFO Êó∂Èó¥Á∫ø, Â§ñÊòü‰∫∫Êé•Ëß¶, l√≠nea de tiempo OVNI, encuentros extraterrestres, ÿ¨ÿØŸàŸÑ ÿ≤ŸÖŸÜŸä UFO, ŸÑŸÇÿßÿ°ÿßÿ™ ÿÆÿßÿ±ÿ¨ ŸÉŸàŸÉÿ® ÿßŸÑÿ£ÿ±ÿ∂, linha do tempo OVNI, encontros extraterrestres">
    <meta name="robots" content="index, follow">
    
    <!-- Multilingual hreflang tags -->
    <link rel="alternate" hreflang="en" href="https://unclebulgaria9001.github.io/disclosureparty/timeline.html">
    <link rel="alternate" hreflang="zh" href="https://unclebulgaria9001.github.io/disclosureparty/timeline.html">
    <link rel="alternate" hreflang="es" href="https://unclebulgaria9001.github.io/disclosureparty/timeline.html">
    <link rel="alternate" hreflang="ar" href="https://unclebulgaria9001.github.io/disclosureparty/timeline.html">
    <link rel="alternate" hreflang="pt" href="https://unclebulgaria9001.github.io/disclosureparty/timeline.html">
    <link rel="alternate" hreflang="x-default" href="https://unclebulgaria9001.github.io/disclosureparty/timeline.html">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json?v=20260103">
    <meta name="theme-color" content="#58a6ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Disclosure DB">
    
    <script src="https://d3js.org/d3.v7.min.js?v=20260103"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="i18n/language-switcher.css">
    <script src="i18n/translations.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Share Tech Mono', 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 0;
        }
        
        header {
            text-align: center;
            padding: 15px 20px;
            background: linear-gradient(180deg, #161b22 0%, #0d1117 100%);
            border-bottom: 1px solid #30363d;
        }
        
        h1 {
            color: #58a6ff;
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #8b949e;
            font-size: 0.8em;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            flex-wrap: wrap;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            padding: 10px 20px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            overflow-x: auto;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .tab {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.2s ease;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        .tab.active {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }
        
        .btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85em;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        .btn.active {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }
        
        .main-layout {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 320px;
            background: #161b22;
            border-right: 1px solid #30363d;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.collapsed {
            margin-left: -320px;
        }
        
        .sidebar-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            height: 100%;
        }
        
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85em;
            border-radius: 6px;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            font-weight: 600;
        }
        
        .toggle-sidebar:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        .toggle-sidebar::before {
            content: '‚ò∞ ';
            font-size: 1.2em;
        }
        
        .timeline-container {
            flex: 1;
            padding: 20px;
            overflow-x: auto;
        }
        
        #timeline {
            width: 100%;
            min-height: 800px;
            background: #0d1117;
            position: relative;
        }
        
        #mapView {
            width: 100%;
            height: 800px;
            background: #0d1117;
            position: relative;
            display: none;
        }
        
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px 20px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }
        
        .view-toggle .btn {
            min-width: 120px;
        }
        
        .leaflet-popup-content-wrapper {
            background: #161b22;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }
        
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Share Tech Mono', monospace;
        }
        
        .leaflet-popup-tip {
            background: #161b22;
        }
        
        .map-popup-title {
            color: #58a6ff;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        
        .map-popup-date {
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        
        .map-popup-description {
            color: #c9d1d9;
            font-size: 0.85em;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .map-popup-link {
            color: #58a6ff;
            text-decoration: none;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        .map-popup-link:hover {
            text-decoration: underline;
        }
        
        .timeline-axis {
            stroke: #30363d;
            stroke-width: 2;
        }
        
        .timeline-track {
            stroke: #21262d;
            stroke-width: 1;
            fill: none;
        }
        
        .event-node {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-node.outbound {
            fill: #58a6ff;
            stroke: #1f6feb;
            stroke-width: 2.5;
        }
        
        .event-node.inbound {
            fill: #f85149;
            stroke: #da3633;
            stroke-width: 2.5;
        }
        
        .event-node.chronology {
            fill: #8b949e;
            stroke: #6e7681;
            stroke-width: 1.5;
        }
        
        .event-node.contact-attempt {
            fill: #a371f7;
            stroke: #8957e5;
            stroke-width: 2.5;
        }
        
        .event-node:focus {
            outline: 3px solid #ffffff;
            outline-offset: 2px;
        }
        
        .event-node:hover {
            filter: brightness(1.2);
            stroke-width: 3;
        }
        
        .event-node:hover {
            r: 10;
            filter: brightness(1.3);
        }
        
        .event-label {
            font-size: 11px;
            fill: #8b949e;
            pointer-events: none;
        }
        
        .tooltip {
            position: absolute;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-title {
            color: #58a6ff;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .tooltip-date {
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        
        .tooltip-description {
            color: #c9d1d9;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            font-size: 0.9em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.outbound {
            background: #58a6ff;
        }
        
        .legend-dot.inbound {
            background: #f85149;
        }
        
        .legend-dot.contact-attempt {
            background: #a371f7;
        }
        
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #1f6feb;
        }
        
        .back-link {
            text-align: center;
            padding: 20px;
        }
        
        .back-link a {
            color: #58a6ff;
            text-decoration: none;
            font-size: 0.9em;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal.visible {
            display: block;
        }
        
        .modal-content {
            background: #0d1117;
            border-left: 1px solid #30363d;
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 800px;
            height: 100%;
            overflow-y: auto;
            padding: 30px;
            transition: right 0.3s ease-in-out;
            z-index: 1001;
            box-sizing: border-box;
        }
        
        .modal.visible .modal-content {
            right: 0;
        }
        
        @media (max-width: 1024px) {
            .modal-content {
                max-width: 700px;
            }
        }
        
        .modal-close {
            position: sticky;
            top: 15px;
            float: right;
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .modal-close:hover {
            background: #30363d;
            border-color: #58a6ff;
        }
        
        .modal h2 {
            color: #58a6ff;
            margin-top: 0;
            margin-bottom: 15px;
            clear: both;
        }
        
        .modal p {
            color: #c9d1d9;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .modal-body img {
            max-width: 100%;
            height: auto;
            margin: 15px 0;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        
        .modal-links {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #30363d;
        }
        
        .modal-links a {
            color: #58a6ff;
            text-decoration: none;
            display: block;
            margin: 5px 0;
            word-break: break-all;
        }
        
        .modal-links a:hover {
            text-decoration: underline;
        }
        
        .modal-tags {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .modal-tag {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .filter-section {
            margin-bottom: 25px;
        }
        
        .filter-section-title {
            color: #58a6ff;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        
        .filter-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-buttons .btn {
            width: 100%;
            text-align: left;
        }
        
        .period-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
        }
        
        .period-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #c9d1d9;
            cursor: pointer;
            vertical-align: middle;
        }
        
        .period-label input[type="checkbox"] {
            margin: 0;
            flex-shrink: 0;
        }
        
        .period-label span {
            line-height: 1;
            vertical-align: middle;
        }
        
        .period-label:hover {
            color: #58a6ff;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #30363d;
            }
            
            .sidebar.collapsed {
                margin-left: 0;
                margin-top: -100%;
            }
            
            .toggle-sidebar {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 data-i18n="siteTitle">UAP/UFO/NHI DISCLOSURE DATABASE</h1>
            <div class="subtitle" data-i18n="timelineSubtitle">Interactive Timeline Visualization</div>
            <button id="installBtn" class="btn" onclick="installApp()" style="display: none; margin: 10px auto;" data-i18n="installApp">üì± Install App</button>
        </header>
        
        <div class="tabs" style="display: flex; justify-content: center; gap: 10px; padding: 20px; flex-wrap: wrap; background: #161b22; border-bottom: 1px solid #30363d;">
            <div class="tab" onclick="window.location.href='viewer.html'" data-i18n="index">INDEX</div>
            <div class="tab" onclick="window.location.href='viewer.html#chronology'" data-i18n="chronology">CHRONOLOGY</div>
            <div class="tab" onclick="window.location.href='viewer.html#contact'" data-i18n="requestContact">REQUEST NHI CONTACT</div>
            <div class="tab active" data-i18n="timelineViz">TIMELINE VIZ</div>
            <div class="tab" onclick="showMapView()" data-i18n="geoTimeline">üó∫Ô∏è GEOTIMELINE</div>
        </div>
        
        <div id="languageSwitcherContainer"></div>
        <button class="toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar(event)" data-i18n="filters">FILTERS</button>
        
        <div class="main-layout">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="color: #8b949e; font-size: 0.85em; margin-bottom: 10px;">
                            <span id="eventCount">Loading events...</span>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-title" data-i18n="timePeriodFilters">TIME PERIOD FILTERS</div>
                        <div class="period-grid">
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2030" checked onchange="applyPeriodFilters()">
                                <span>2030</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2029" checked onchange="applyPeriodFilters()">
                                <span>2029</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2028" checked onchange="applyPeriodFilters()">
                                <span>2028</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2027" checked onchange="applyPeriodFilters()">
                                <span>2027</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2026" checked onchange="applyPeriodFilters()">
                                <span>2026</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2025" checked onchange="applyPeriodFilters()">
                                <span>2025</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2024" checked onchange="applyPeriodFilters()">
                                <span>2024</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2023" checked onchange="applyPeriodFilters()">
                                <span>2023</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2022" checked onchange="applyPeriodFilters()">
                                <span>2022</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2021" checked onchange="applyPeriodFilters()">
                                <span>2021</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2020" checked onchange="applyPeriodFilters()">
                                <span>2020</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2019" checked onchange="applyPeriodFilters()">
                                <span>2019</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2018" checked onchange="applyPeriodFilters()">
                                <span>2018</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2017" checked onchange="applyPeriodFilters()">
                                <span>2017</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2016" checked onchange="applyPeriodFilters()">
                                <span>2016</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2015" checked onchange="applyPeriodFilters()">
                                <span>2015</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2014" checked onchange="applyPeriodFilters()">
                                <span>2014</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2013" checked onchange="applyPeriodFilters()">
                                <span>2013</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2012" checked onchange="applyPeriodFilters()">
                                <span>2012</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2011" checked onchange="applyPeriodFilters()">
                                <span>2011</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="2010" checked onchange="applyPeriodFilters()">
                                <span>2010</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="200" checked onchange="applyPeriodFilters()">
                                <span>2000s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="199" checked onchange="applyPeriodFilters()">
                                <span>1990s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="198" checked onchange="applyPeriodFilters()">
                                <span>1980s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="197" checked onchange="applyPeriodFilters()">
                                <span>1970s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="196" checked onchange="applyPeriodFilters()">
                                <span>1960s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="195" checked onchange="applyPeriodFilters()">
                                <span>1950s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="194" checked onchange="applyPeriodFilters()">
                                <span>1940s <span class="period-count" data-period="194"></span></span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="193" checked onchange="applyPeriodFilters()">
                                <span>1930s <span class="period-count" data-period="193"></span></span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="192" checked onchange="applyPeriodFilters()">
                                <span>1920s <span class="period-count" data-period="192"></span></span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="191" checked onchange="applyPeriodFilters()">
                                <span>1910s <span class="period-count" data-period="191"></span></span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="18" onchange="applyPeriodFilters()">
                                <span>1800s</span>
                            </label>
                            <label class="period-label">
                                <input type="checkbox" class="period-filter" value="ancient" onchange="applyPeriodFilters()">
                                <span>ANCIENT</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="btn" style="flex: 1;" onclick="selectAllPeriods()" data-i18n="selectAll">ALL</button>
                            <button class="btn" style="flex: 1;" onclick="deselectAllPeriods()" data-i18n="deselectAll">NONE</button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-title">CONTENT FILTERS</div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                            <label class="period-label">
                                <input type="checkbox" id="photoFilter" onchange="applyContentFilters()">
                                <span>With Photos Only</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-title">CATEGORY TAGS</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.75em;">
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Outbound" checked onchange="applyTagFilters()">
                                <span>Outbound <span class="tag-count" data-tag="Outbound"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Inbound" checked onchange="applyTagFilters()">
                                <span>Inbound <span class="tag-count" data-tag="Inbound"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="ContactAttempt" checked onchange="applyTagFilters()">
                                <span>Contact Attempt <span class="tag-count" data-tag="ContactAttempt"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="LegislationPolicy" checked onchange="applyTagFilters()">
                                <span>Legislation <span class="tag-count" data-tag="LegislationPolicy"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="CongressionalHearings" checked onchange="applyTagFilters()">
                                <span>Hearings <span class="tag-count" data-tag="CongressionalHearings"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="LeaksDeclass" checked onchange="applyTagFilters()">
                                <span>Leaks/FOIA <span class="tag-count" data-tag="LeaksDeclass"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="WhistleblowerDisclosures" checked onchange="applyTagFilters()">
                                <span>Whistleblower <span class="tag-count" data-tag="WhistleblowerDisclosures"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="MilitaryEncounters" checked onchange="applyTagFilters()">
                                <span>Military <span class="tag-count" data-tag="MilitaryEncounters"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="CivilianSightings" checked onchange="applyTagFilters()">
                                <span>Civilian <span class="tag-count" data-tag="CivilianSightings"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="AbductionCEIII" checked onchange="applyTagFilters()">
                                <span>Abduction <span class="tag-count" data-tag="AbductionCEIII"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="CrashRetrievals" checked onchange="applyTagFilters()">
                                <span>Crash/Retrieval <span class="tag-count" data-tag="CrashRetrievals"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="UnderwaterUSO" checked onchange="applyTagFilters()">
                                <span>USO <span class="tag-count" data-tag="UnderwaterUSO"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="SpaceSatellite" checked onchange="applyTagFilters()">
                                <span>Space <span class="tag-count" data-tag="SpaceSatellite"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="ScientificStudies" checked onchange="applyTagFilters()">
                                <span>Scientific <span class="tag-count" data-tag="ScientificStudies"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="HistoricalPreModern" checked onchange="applyTagFilters()">
                                <span>Historical <span class="tag-count" data-tag="HistoricalPreModern"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="ReligiousCultural" checked onchange="applyTagFilters()">
                                <span>Religious <span class="tag-count" data-tag="ReligiousCultural"></span></span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="btn" style="flex: 1;" onclick="selectAllTags()">ALL</button>
                            <button class="btn" style="flex: 1;" onclick="deselectAllTags()">NONE</button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-title">GEOGRAPHIC REGIONS</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.75em;">
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="USA" checked onchange="applyTagFilters()">
                                <span>USA <span class="tag-count" data-tag="USA"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Europe" checked onchange="applyTagFilters()">
                                <span>Europe <span class="tag-count" data-tag="Europe"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="LatinAmerica" checked onchange="applyTagFilters()">
                                <span>Latin America <span class="tag-count" data-tag="LatinAmerica"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Asia" checked onchange="applyTagFilters()">
                                <span>Asia <span class="tag-count" data-tag="Asia"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="MiddleEast" checked onchange="applyTagFilters()">
                                <span>Middle East <span class="tag-count" data-tag="MiddleEast"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Africa" checked onchange="applyTagFilters()">
                                <span>Africa <span class="tag-count" data-tag="Africa"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Oceania" checked onchange="applyTagFilters()">
                                <span>Oceania <span class="tag-count" data-tag="Oceania"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Canada" checked onchange="applyTagFilters()">
                                <span>Canada <span class="tag-count" data-tag="Canada"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="Russia" checked onchange="applyTagFilters()">
                                <span>Russia <span class="tag-count" data-tag="Russia"></span></span>
                            </label>
                            <label class="period-label" style="font-size: 0.85em;">
                                <input type="checkbox" class="tag-filter" value="International" checked onchange="applyTagFilters()">
                                <span>International <span class="tag-count" data-tag="International"></span></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-title" data-i18n="legend">LEGEND</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.75em;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <rect x="-5" y="-5" width="10" height="10" fill="#58a6ff" stroke="#1f6feb" stroke-width="1.5"/>
                                </svg>
                                <span>Outbound</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <polygon points="0,-6.5 5.5,3.5 -5.5,3.5" fill="#f85149" stroke="#da3633" stroke-width="1.5"/>
                                </svg>
                                <span>Inbound</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <polygon points="0,-6 6,0 0,6 -6,0" fill="#a371f7" stroke="#8957e5" stroke-width="1.5"/>
                                </svg>
                                <span>Contact</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <rect x="-4" y="-6" width="8" height="12" rx="1" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Legislation</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M-5,2.5 L0,-6 L5,2.5 L3,2.5 L3,6 L-3,6 L-3,2.5 Z" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Hearings</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M-6,-4 L6,-4 L6,6 L-6,6 Z M-3,-1 L3,-1 M-4,1.5 L2,1.5 M-3,4 L4,4" fill="#8b949e" stroke="#6e7681" stroke-width="1.2"/>
                                </svg>
                                <span>Leaks/FOIA</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <circle r="5.5" fill="none" stroke="#8b949e" stroke-width="2"/>
                                </svg>
                                <span>Whistleblower</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M0,-6.5 L6,6.5 L-6,6.5 Z" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Military</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <circle r="5" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Civilian</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <ellipse rx="3.5" ry="6.5" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Abduction</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M-6,-2.5 L0,-6 L6,-2.5 L4,6 L-4,6 Z" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Crash</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M-6,0 Q-6,-6 0,-6 Q6,-6 6,0 Q6,6 0,6 Q-6,6 -6,0" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>USO</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M0,-6.5 L2,-1.5 L6.5,-1.5 L2.5,1.5 L4,6.5 L0,3.5 L-4,6.5 L-2.5,1.5 L-6.5,-1.5 L-2,-1.5 Z" fill="#8b949e" stroke="#6e7681" stroke-width="1.2"/>
                                </svg>
                                <span>Space</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M-5.5,4 L-5.5,-4 L5.5,-4 L5.5,4 M-3.5,-2 L3.5,-2 M-3.5,0 L3.5,0 M-3.5,2 L3.5,2" fill="none" stroke="#8b949e" stroke-width="1.2"/>
                                </svg>
                                <span>Scientific</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <rect x="-5.5" y="-4.5" width="11" height="9" rx="1.5" fill="#8b949e" stroke="#6e7681" stroke-width="1.5"/>
                                </svg>
                                <span>Historical</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <svg width="14" height="14" viewBox="-7 -7 14 14">
                                    <path d="M0,-6.5 L1.5,-1.5 L6,-1.5 L2,1 L3.5,6 L0,3 L-3.5,6 L-2,1 L-6,-1.5 L-1.5,-1.5 Z" fill="#8b949e" stroke="#6e7681" stroke-width="1.2"/>
                                </svg>
                                <span>Religious</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #30363d;">
                        <a href="viewer.html" style="color: #58a6ff; text-decoration: none; font-size: 0.85em;" data-i18n="backToViewer">‚Üê Back to Main Viewer</a>
                    </div>
                </div>
            </div>
            
            <div class="timeline-container">
                <div style="text-align: center; padding: 20px 0;">
                    <h2 style="color: #58a6ff; margin-bottom: 10px;" data-i18n="chronologyTitle">UAP/UFO/NHI CHRONOLOGY TIMELINE</h2>
                    <div style="color: #8b949e; font-size: 0.9em;">Interactive visualization of sightings, encounters, communications, and disclosure events</div>
                </div>
                <div class="view-toggle">
                    <button class="btn active" onclick="showTimelineView()" id="timelineViewBtn">üìä TIMELINE VIEW</button>
                    <button class="btn" onclick="showMapView()" id="mapViewBtn">üó∫Ô∏è MAP VIEW</button>
                </div>
                <div id="timeline" role="application" aria-label="Interactive timeline of UAP and communication events"></div>
                <div id="mapView" role="application" aria-label="Interactive map of UAP and communication events"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-date"></div>
        <div class="tooltip-description"></div>
    </div>
    
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-date" id="modalDate"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-links" id="modalLinks"></div>
            <div class="modal-tags" id="modalTags"></div>
        </div>
    </div>
    
    <script>
        // All events (will be populated from chronology + communication events)
        let allEvents = [];
        
        // Communication events data
        const communicationEvents = [
            // Outbound Communications
            {
                date: new Date(1972, 2, 2),
                originalDateStr: '1972',
                type: 'outbound',
                title: 'Pioneer 10 Plaque',
                description: 'First physical message from humanity. Gold-anodized aluminum plaque with human figures and Earth\'s location.',
                tags: ['Outbound'],
                location: 'Cape Canaveral, Florida, USA',
                coordinates: [28.5729, -80.6490]
            },
            {
                date: new Date(1973, 2, 3),
                type: 'outbound',
                title: 'Pioneer 11 Plaque',
                description: 'Identical plaque to Pioneer 10, continuing humanity\'s first physical messages to space.',
                tags: ['Outbound'],
                location: 'Cape Canaveral, Florida, USA',
                coordinates: [28.5729, -80.6490]
            },
            {
                date: new Date(1974, 10, 16),
                type: 'outbound',
                title: 'Arecibo Message',
                description: 'First deliberate interstellar radio message. 1,679-bit signal sent to M13 cluster 25,000 light years away.',
                tags: ['Outbound'],
                location: 'Arecibo Observatory, Puerto Rico',
                coordinates: [18.3464, -66.7528]
            },
            {
                date: new Date(1977, 7, 20),
                type: 'outbound',
                title: 'Voyager Golden Records',
                description: '12-inch gold-plated records with 116 images, greetings in 55 languages, and 90 minutes of music.',
                tags: ['Outbound'],
                location: 'Cape Canaveral, Florida, USA',
                coordinates: [28.5729, -80.6490]
            },
            {
                date: new Date(1999, 4, 24),
                type: 'outbound',
                title: 'Cosmic Call',
                description: 'Radio message using sophisticated "Lexicon" mathematical language toward nearby stars.',
                tags: ['Outbound'],
                location: 'Evpatoria, Crimea',
                coordinates: [45.1983, 33.3667]
            },
            {
                date: new Date(2001, 8, 3),
                type: 'outbound',
                title: 'Teen Age Message',
                description: 'First interstellar message composed by teenagers, transmitted to six sun-like stars.',
                tags: ['Outbound'],
                location: 'Evpatoria, Crimea',
                coordinates: [45.1983, 33.3667]
            },
            {
                date: new Date(2003, 6, 6),
                type: 'outbound',
                title: 'Cosmic Call 2',
                description: 'Second Cosmic Call transmission to five additional stars.',
                tags: ['Outbound'],
                location: 'Evpatoria, Crimea',
                coordinates: [45.1983, 33.3667]
            },
            {
                date: new Date(2008, 7, 28),
                type: 'outbound',
                title: 'Hello from Earth',
                description: 'First crowdsourced message via Bebo. 501 messages from 195 countries to Gliese 581c.',
                tags: ['Outbound'],
                location: 'Canberra, Australia',
                coordinates: [-35.2809, 149.1300]
            },
            {
                date: new Date(2026, 0, 1),
                type: 'outbound',
                title: 'Request Direct NHI Communication',
                description: 'Public message requesting direct, transparent communication, bypassing government intermediaries.',
                tags: ['Outbound'],
                location: 'Global / Internet',
                coordinates: [0, 0]
            },
            
            // Inbound Communications
            {
                date: new Date(1977, 7, 15),
                type: 'inbound',
                title: 'Wow! Signal',
                description: 'Strong 72-second narrowband radio signal from Sagittarius. Never detected again despite follow-ups.',
                tags: ['Inbound'],
                location: 'Big Ear Radio Observatory, Ohio, USA',
                coordinates: [40.2500, -83.0500]
            },
            {
                date: new Date(2001, 7, 14),
                type: 'inbound',
                title: 'Chilbolton Face Formation',
                description: 'Crop formation showing humanoid face near Chilbolton radio telescope, Hampshire, UK.',
                tags: ['Inbound'],
                location: 'Chilbolton, Hampshire, UK',
                coordinates: [51.1500, -1.4400]
            },
            {
                date: new Date(2001, 7, 19),
                type: 'inbound',
                title: 'Chilbolton Arecibo Reply',
                description: 'Crop formation mirroring 1974 Arecibo message structure with different data: silicon-based DNA, different population.',
                tags: ['Inbound'],
                location: 'Chilbolton, Hampshire, UK',
                coordinates: [51.1500, -1.4400]
            },
            {
                date: new Date(2002, 7, 15),
                type: 'inbound',
                title: 'Crabwood Formation',
                description: 'Crop formation with alien face and binary message: "Beware the bearers of false gifts... Conduit closing."',
                tags: ['Inbound'],
                location: 'Crabwood, Winchester, UK',
                coordinates: [51.0633, -1.3100]
            },
            
            // Contact Attempts (In-Person)
            {
                date: new Date(1994, 3, 16),
                originalDateStr: '1994, April 16',
                type: 'contact-attempt',
                title: 'Ariel School, Zimbabwe',
                description: '62 pupils (ages 5-12) witnessed silvery cigar-shaped craft hover above playground. Many described receiving non-verbal "thought message" about caring for Earth. Investigated by Dr. John Mack and Cynthia Hind.',
                tags: ['ContactAttempt'],
                location: 'Ruwa, Zimbabwe',
                coordinates: [-17.8900, 31.2450]
            },
            {
                date: new Date(1996, 8, 10),
                originalDateStr: '1996, September 10',
                type: 'contact-attempt',
                title: 'Matanzas Rural School, Cuba',
                description: 'Dozens of children witnessed large glowing oval craft silently over assembly area. Pupils reported lights swept toward them in patterned sequence, as if trying to communicate.',
                tags: ['ContactAttempt'],
                location: 'Matanzas, Cuba',
                coordinates: [23.0414, -81.5775]
            },
            {
                date: new Date(1996, 0, 1),
                originalDateStr: '1996',
                type: 'contact-attempt',
                title: 'Varginha, Brazil',
                description: 'Multiple townspeople reported humanoid "grey" beings and nearby craft. One of Latin America\'s highest-profile mass-contact claims with physical evidence reports.',
                tags: ['ContactAttempt'],
                location: 'Varginha, Brazil',
                coordinates: [-21.5519, -45.4328]
            }
        ];
        
        // Load chronology data
        async function loadChronology() {
            try {
                const response = await fetch('dist/chronology.md');
                const text = await response.text();
                parseChronologyEvents(text);
            } catch (error) {
                console.error('Error loading chronology:', error);
                allEvents = [...communicationEvents];
                initializeTimeline();
            }
        }
        
        function parseChronologyEvents(text) {
            const lines = text.split('\n');
            const chronologyEvents = [];
            
            for (let line of lines) {
                line = line.trim();
                
                // Match headers like "## 2025, September 9 - Title #tag1 #tag2" or "## 70 CE - Title"
                const headerMatch = line.match(/^##\s+(\d{1,4}(?:\s+(?:BCE|CE))?(?:,\s+[A-Za-z]+(?:\s+\d{1,2})?)?)\s+-\s+(.+)/i);
                
                if (headerMatch) {
                    const dateStr = headerMatch[1];
                    let titleAndTags = headerMatch[2];
                    
                    // Extract tags from title (handles both #tag1 #tag2 and #tag1#tag2 formats)
                    const tags = [];
                    const tagMatches = titleAndTags.match(/#[\w-]+/g);
                    if (tagMatches) {
                        tags.push(...tagMatches.map(tag => tag.substring(1))); // Remove # prefix
                        // Remove tags from title
                        titleAndTags = titleAndTags.replace(/#[\w-]+/g, '').trim();
                    }
                    
                    const title = titleAndTags;
                    
                    // Parse date
                    const date = parseDateString(dateStr);
                    if (date) {
                        // Include all events (ancient and modern)
                        chronologyEvents.push({
                            title: title,
                            date: date,
                            originalDateStr: dateStr,
                            description: '',
                            type: 'chronology',
                            tags: tags
                        });
                    }
                }
            }
            
            // Combine communication events and chronology events
            allEvents = [...communicationEvents, ...chronologyEvents];
            allEvents.sort((a, b) => a.date - b.date);
            
            // Debug: Log sample events
            console.log('Total events:', allEvents.length);
            console.log('Communication events:', communicationEvents.length);
            console.log('Chronology events:', chronologyEvents.length);
            console.log('Sample chronology events:', chronologyEvents.slice(0, 5));
            console.log('Date range:', {
                min: d3.min(allEvents.map(d => d.date)),
                max: d3.max(allEvents.map(d => d.date))
            });
            
            document.getElementById('eventCount').textContent = 
                `Showing ${allEvents.length} events (${communicationEvents.length} communications, ${chronologyEvents.length} chronology)`;
            
            initializeTimeline();
        }
        
        function parseDateString(dateStr) {
            // Handle BCE/CE dates - JavaScript Date doesn't support BCE, so use year 1 as baseline
            const bceMatch = dateStr.match(/^(\d+)\s+BCE/i);
            if (bceMatch) {
                const year = parseInt(bceMatch[1]);
                // Map BCE to early dates: 1000 BCE = year 1, 1 BCE = year 1000
                return new Date(1000 - year, 0, 1);
            }
            
            const ceMatch = dateStr.match(/^(\d+)\s+CE/i);
            if (ceMatch) {
                const year = parseInt(ceMatch[1]);
                // Map CE 1-1000 to years 1000-2000 to avoid overlap with modern dates
                if (year < 1000) {
                    return new Date(1000 + year, 0, 1);
                }
                return new Date(year, 0, 1);
            }
            
            // Handle modern dates like "2025, September 9"
            const modernMatch = dateStr.match(/^(\d{4})(?:,\s+([A-Za-z]+)(?:\s+(\d{1,2}))?)?/);
            if (modernMatch) {
                const year = parseInt(modernMatch[1]);
                const monthName = modernMatch[2];
                const day = modernMatch[3] ? parseInt(modernMatch[3]) : 1;
                
                if (monthName) {
                    const months = {
                        'january': 0, 'february': 1, 'march': 2, 'april': 3,
                        'may': 4, 'june': 5, 'july': 6, 'august': 7,
                        'september': 8, 'october': 9, 'november': 10, 'december': 11
                    };
                    const month = months[monthName.toLowerCase()];
                    if (month !== undefined) {
                        return new Date(year, month, day);
                    }
                }
                
                return new Date(year, 0, 1);
            }
            
            return null;
        }
        
        // Initialize on page load
        loadChronology();
        
        function initializeTimeline() {
            if (allEvents.length === 0) return;
            
            // Clear existing SVG
            d3.select('#timeline svg').remove();
            
            drawTimeline();
        }
        
        function drawTimeline() {
            // Timeline dimensions - rotated 90 degrees
            const margin = {top: 60, right: 200, bottom: 40, left: 60};
            // Set minimum width for 16 swim lanes with balanced spacing
            const width = Math.max(document.getElementById('timeline').clientWidth - margin.left - margin.right, 1600);
            const height = 800;
            
            // Create SVG
            const svg = d3.select('#timeline')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Use all events for display (including ancient)
            const modernEvents = allEvents;
            
            // Find date range from modern events with padding
            const dates = modernEvents.map(d => d.date);
            const minDate = d3.min(dates);
            const maxDate = d3.max(dates);
            
            // Add padding to date range (5% on each side)
            const dateRange = maxDate - minDate;
            const paddedMin = new Date(minDate.getTime() - dateRange * 0.05);
            const paddedMax = new Date(maxDate.getTime() + dateRange * 0.05);
            
            // Scales - vertical timeline
            const yScale = d3.scaleTime()
                .domain([paddedMin, paddedMax])
                .range([0, height]);
            
            // Define all category tags (swim lanes)
            const categoryTags = [
                'Outbound', 'Inbound', 'ContactAttempt',
                'LegislationPolicy', 'CongressionalHearings', 'LeaksDeclass',
                'WhistleblowerDisclosures', 'MilitaryEncounters', 'CivilianSightings',
                'AbductionCEIII', 'CrashRetrievals', 'UnderwaterUSO',
                'SpaceSatellite', 'ScientificStudies', 'HistoricalPreModern',
                'ReligiousCultural',
                'USA', 'Europe', 'LatinAmerica', 'Asia', 'MiddleEast',
                'Africa', 'Oceania', 'Canada', 'Russia', 'International'
            ];
            
            const categoryLabels = {
                'Outbound': 'OUTBOUND',
                'Inbound': 'INBOUND',
                'ContactAttempt': 'CONTACT',
                'LegislationPolicy': 'LEGISLATION',
                'CongressionalHearings': 'HEARINGS',
                'LeaksDeclass': 'LEAKS/FOIA',
                'WhistleblowerDisclosures': 'WHISTLEBLOWER',
                'MilitaryEncounters': 'MILITARY',
                'CivilianSightings': 'CIVILIAN',
                'AbductionCEIII': 'ABDUCTION',
                'CrashRetrievals': 'CRASH',
                'UnderwaterUSO': 'USO',
                'SpaceSatellite': 'SPACE',
                'ScientificStudies': 'SCIENTIFIC',
                'HistoricalPreModern': 'HISTORICAL',
                'ReligiousCultural': 'RELIGIOUS',
                'USA': 'USA',
                'Europe': 'EUROPE',
                'LatinAmerica': 'LATIN\nAMERICA',
                'Asia': 'ASIA',
                'MiddleEast': 'MIDDLE\nEAST',
                'Africa': 'AFRICA',
                'Oceania': 'OCEANIA',
                'Canada': 'CANADA',
                'Russia': 'RUSSIA',
                'International': 'INTL'
            };
            
            // Calculate x positions for each swim lane with generous spacing
            const laneSpacing = width / (categoryTags.length + 1);
            const lanePositions = {};
            categoryTags.forEach((tag, i) => {
                lanePositions[tag] = laneSpacing * (i + 1);
            });
            
            console.log('Swim lane spacing:', laneSpacing, 'px between lanes');
        
            // Check if we have any truly ancient events (BCE/CE before year 1000) in the current view
            const hasAncientEvents = modernEvents.some(e => e.date.getFullYear() < 1900);
            
            // Axes with custom tick format - only show BCE/CE if ancient events exist
            const yAxis = d3.axisLeft(yScale)
                .ticks(20)
                .tickFormat(d => {
                    const year = d.getFullYear();
                    
                    // Only use BCE/CE format if we have truly ancient events (pre-1900)
                    if (hasAncientEvents && year < 1900) {
                        if (year < 1000) {
                            return `${1000 - year} BCE`;
                        } else if (year >= 1000 && year < 2000) {
                            return `${year - 1000} CE`;
                        }
                    }
                    
                    // Show modern years normally (1900+)
                    return year.toString();
                });
        
        svg.append('g')
            .attr('class', 'y-axis')
            .attr('transform', `translate(0,0)`)
            .call(yAxis)
            .selectAll('text')
            .style('fill', '#8b949e')
            .style('font-family', 'Share Tech Mono');
        
        svg.selectAll('.y-axis path, .y-axis line')
            .style('stroke', '#30363d');
        
            // Timeline tracks - vertical (one per category)
            categoryTags.forEach(tag => {
                const x = lanePositions[tag];
                svg.append('line')
                    .attr('class', 'timeline-track')
                    .attr('x1', x)
                    .attr('y1', 0)
                    .attr('x2', x)
                    .attr('y2', height);
            });
            
            // Track labels - vertical with line breaks for multi-word labels
            categoryTags.forEach(tag => {
                const x = lanePositions[tag];
                const label = categoryLabels[tag];
                
                // Color coding for special categories
                let color = '#8b949e';
                if (tag === 'Outbound') color = '#58a6ff';
                else if (tag === 'Inbound') color = '#f85149';
                else if (tag === 'ContactAttempt') color = '#a371f7';
                
                // Split label into lines if it contains multiple words
                const words = label.split(/[\s\/]+/);
                if (words.length > 1) {
                    // Multi-word label - create tspan for each line
                    const text = svg.append('text')
                        .attr('x', x)
                        .attr('y', -25)
                        .attr('text-anchor', 'middle')
                        .style('fill', color)
                        .style('font-size', '8px')
                        .style('font-weight', '600');
                    
                    words.forEach((word, i) => {
                        text.append('tspan')
                            .attr('x', x)
                            .attr('dy', i === 0 ? 0 : '1em')
                            .text(word);
                    });
                } else {
                    // Single word label
                    svg.append('text')
                        .attr('x', x)
                        .attr('y', -15)
                        .attr('text-anchor', 'middle')
                        .attr('dominant-baseline', 'auto')
                        .style('fill', color)
                        .style('font-size', '9px')
                        .style('font-weight', '600')
                        .text(label);
                }
            });
        
        // Tooltip
        const tooltip = d3.select('#tooltip');
        
            // Draw events
            console.log('Drawing', allEvents.length, 'events');
            console.log('Event types:', {
                outbound: allEvents.filter(d => d.type === 'outbound').length,
                inbound: allEvents.filter(d => d.type === 'inbound').length,
                chronology: allEvents.filter(d => d.type === 'chronology').length
            });
            
            // Debug: Track unmatched tags
            const unmatchedTags = new Set();
            allEvents.forEach(event => {
                // Track tags that don't match our categories
                if (event.tags && event.tags.length > 0) {
                    event.tags.forEach(tag => {
                        if (!categoryTags.includes(tag) && 
                            !categoryTags.find(ct => ct.toLowerCase() === tag.toLowerCase())) {
                            unmatchedTags.add(tag);
                        }
                    });
                }
            });
            console.log('Unmatched tags found in chronology.md:', Array.from(unmatchedTags).sort());
            
            // Helper function to get all matching category tags for an event
            function getMatchingTags(event) {
                const matchedTags = [];
                
                // For communication events, always include their type-based tag
                if (event.type === 'outbound') matchedTags.push('Outbound');
                if (event.type === 'inbound') matchedTags.push('Inbound');
                if (event.type === 'contact-attempt') matchedTags.push('ContactAttempt');
                
                // Check event tags against category list
                if (event.tags && event.tags.length > 0) {
                    for (const tag of event.tags) {
                        // Try exact match
                        if (categoryTags.includes(tag) && !matchedTags.includes(tag)) {
                            matchedTags.push(tag);
                            continue;
                        }
                        // Try case-insensitive match
                        const found = categoryTags.find(ct => ct.toLowerCase() === tag.toLowerCase());
                        if (found && !matchedTags.includes(found)) {
                            matchedTags.push(found);
                            continue;
                        }
                        // Try partial match
                        const partialMatch = categoryTags.find(ct => 
                            ct.toLowerCase().includes(tag.toLowerCase()) || 
                            tag.toLowerCase().includes(ct.toLowerCase())
                        );
                        if (partialMatch && !matchedTags.includes(partialMatch)) {
                            matchedTags.push(partialMatch);
                        }
                    }
                }
                
                // If no matches found, default to HistoricalPreModern
                return matchedTags.length > 0 ? matchedTags : ['HistoricalPreModern'];
            }
            
            // Create event instances for each matching swim lane
            const eventInstances = [];
            allEvents.forEach(event => {
                const matchingTags = getMatchingTags(event);
                matchingTags.forEach(tag => {
                    eventInstances.push({
                        ...event,
                        swimLaneTag: tag
                    });
                });
            });
            
            console.log('Event instances created:', eventInstances.length, 'from', allEvents.length, 'events');
            
            // Draw events with different shapes for accessibility - vertical
            const eventGroups = svg.selectAll('.event-group')
                .data(eventInstances)
                .enter()
                .append('g')
                .attr('class', 'event-group')
                .attr('data-swim-lane', d => d.swimLaneTag)
                .attr('transform', d => {
                    const y = yScale(d.date);
                    const x = lanePositions[d.swimLaneTag] || lanePositions['HistoricalPreModern'];
                    return `translate(${x},${y})`;
                })
                .attr('role', 'button')
                .attr('tabindex', '0')
                .attr('aria-label', d => {
                    const tagLabel = categoryLabels[d.swimLaneTag] || d.swimLaneTag;
                    return `${d.title}, ${tagLabel}, ${d.originalDateStr || d3.timeFormat('%Y')(d.date)}`;
                });
            
            // Icon mapping for each category
            const categoryIcons = {
                'Outbound': (g, s) => g.append('rect').attr('x', -s).attr('y', -s).attr('width', s*2).attr('height', s*2),
                'Inbound': (g, s) => g.append('polygon').attr('points', `0,${-s*1.3} ${s*1.1},${s*0.7} ${-s*1.1},${s*0.7}`),
                'ContactAttempt': (g, s) => g.append('polygon').attr('points', `0,${-s*1.2} ${s*1.2},0 0,${s*1.2} ${-s*1.2},0`),
                'LegislationPolicy': (g, s) => g.append('rect').attr('x', -s*0.8).attr('y', -s*1.2).attr('width', s*1.6).attr('height', s*2.4).attr('rx', s*0.2),
                'CongressionalHearings': (g, s) => g.append('path').attr('d', `M${-s},${s*0.5} L0,${-s*1.2} L${s},${s*0.5} L${s*0.6},${s*0.5} L${s*0.6},${s*1.2} L${-s*0.6},${s*1.2} L${-s*0.6},${s*0.5} Z`),
                'LeaksDeclass': (g, s) => g.append('path').attr('d', `M${-s*1.2},${-s*0.8} L${s*1.2},${-s*0.8} L${s*1.2},${s*1.2} L${-s*1.2},${s*1.2} Z M${-s*0.6},${-s*0.2} L${s*0.6},${-s*0.2} M${-s*0.8},${s*0.3} L${s*0.4},${s*0.3} M${-s*0.6},${s*0.8} L${s*0.8},${s*0.8}`),
                'WhistleblowerDisclosures': (g, s) => g.append('circle').attr('r', s*1.1).attr('stroke-width', s*0.4).attr('fill', 'none'),
                'MilitaryEncounters': (g, s) => g.append('path').attr('d', `M0,${-s*1.3} L${s*1.2},${s*1.3} L${-s*1.2},${s*1.3} Z`),
                'CivilianSightings': (g, s) => g.append('circle').attr('r', s),
                'AbductionCEIII': (g, s) => g.append('ellipse').attr('rx', s*0.7).attr('ry', s*1.3),
                'CrashRetrievals': (g, s) => g.append('path').attr('d', `M${-s*1.2},${-s*0.5} L0,${-s*1.2} L${s*1.2},${-s*0.5} L${s*0.8},${s*1.2} L${-s*0.8},${s*1.2} Z`),
                'UnderwaterUSO': (g, s) => g.append('path').attr('d', `M${-s*1.2},0 Q${-s*1.2},${-s*1.2} 0,${-s*1.2} Q${s*1.2},${-s*1.2} ${s*1.2},0 Q${s*1.2},${s*1.2} 0,${s*1.2} Q${-s*1.2},${s*1.2} ${-s*1.2},0`),
                'SpaceSatellite': (g, s) => g.append('path').attr('d', `M0,${-s*1.3} L${s*0.4},${-s*0.3} L${s*1.3},${-s*0.3} L${s*0.5},${s*0.3} L${s*0.8},${s*1.3} L0,${s*0.7} L${-s*0.8},${s*1.3} L${-s*0.5},${s*0.3} L${-s*1.3},${-s*0.3} L${-s*0.4},${-s*0.3} Z`),
                'ScientificStudies': (g, s) => g.append('path').attr('d', `M${-s*1.1},${s*0.8} L${-s*1.1},${-s*0.8} L${s*1.1},${-s*0.8} L${s*1.1},${s*0.8} M${-s*0.7},${-s*0.4} L${s*0.7},${-s*0.4} M${-s*0.7},0 L${s*0.7},0 M${-s*0.7},${s*0.4} L${s*0.7},${s*0.4}`),
                'HistoricalPreModern': (g, s) => g.append('rect').attr('x', -s*1.1).attr('y', -s*0.9).attr('width', s*2.2).attr('height', s*1.8).attr('rx', s*0.3),
                'ReligiousCultural': (g, s) => g.append('path').attr('d', `M0,${-s*1.3} L${s*0.3},${-s*0.3} L${s*1.2},${-s*0.3} L${s*0.4},${s*0.2} L${s*0.7},${s*1.2} L0,${s*0.6} L${-s*0.7},${s*1.2} L${-s*0.4},${s*0.2} L${-s*1.2},${-s*0.3} L${-s*0.3},${-s*0.3} Z`)
            };
            
            // Add different shapes based on swim lane category tag
            eventGroups.each(function(d) {
                const group = d3.select(this);
                const size = 5;
                
                const iconFunc = categoryIcons[d.swimLaneTag];
                if (iconFunc) {
                    const shape = iconFunc(group, size);
                    shape.attr('class', `event-node ${d.type}`);
                } else {
                    // Default circle
                    group.append('circle')
                        .attr('class', `event-node ${d.type}`)
                        .attr('r', size);
                }
            });
            
            window.nodes = eventGroups
            .on('mouseover', function(event, d) {
                tooltip.select('.tooltip-title').text(d.title);
                // Use original date string if available, otherwise format the date
                let dateStr;
                if (d.originalDateStr) {
                    // Check if it's a BCE/CE date
                    if (d.originalDateStr.match(/BCE|CE/i)) {
                        dateStr = d.originalDateStr;
                    } else {
                        // Modern date - parse the year from original string
                        const yearMatch = d.originalDateStr.match(/^(\d{4})/);
                        if (yearMatch) {
                            const year = yearMatch[1];
                            const monthMatch = d.originalDateStr.match(/,\s+([A-Za-z]+)(?:\s+(\d{1,2}))?/);
                            if (monthMatch) {
                                const month = monthMatch[1];
                                const day = monthMatch[2] || '1';
                                dateStr = `${month} ${day}, ${year}`;
                            } else {
                                dateStr = year;
                            }
                        } else {
                            dateStr = d.originalDateStr;
                        }
                    }
                } else {
                    // Fallback for events without originalDateStr
                    dateStr = d3.timeFormat('%B %d, %Y')(d.date);
                }
                tooltip.select('.tooltip-date').text(dateStr);
                tooltip.select('.tooltip-description').text(d.description);
                tooltip.classed('visible', true);
            })
            .on('mousemove', function(event) {
                tooltip
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY - 15) + 'px');
            })
            .on('mouseout', function() {
                tooltip.classed('visible', false);
            })
            .on('click', function(event, d) {
                event.stopPropagation();
                showEventModal(d);
            })
            .on('keydown', function(event, d) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    showEventModal(d);
                }
            })
            .style('cursor', 'pointer');
        
        // Add title labels for all events - vertical
        const eventLabels = svg.selectAll('.event-label')
            .data(eventInstances)
            .enter()
            .append('text')
            .attr('class', 'event-label')
            .attr('data-swim-lane', d => d.swimLaneTag)
            .attr('y', d => yScale(d.date))
            .attr('x', d => {
                const x = lanePositions[d.swimLaneTag] || lanePositions['HistoricalPreModern'];
                return x + 15;
            })
            .attr('text-anchor', 'start')
            .attr('dominant-baseline', 'middle')
            .style('font-size', '9px')
            .style('fill', '#c9d1d9')
            .text(d => {
                // Truncate title to max 30 characters for swim lanes
                const maxLength = 30;
                const title = d.title || 'Untitled';
                return title.length > maxLength ? title.substring(0, maxLength) + '...' : title;
            })
            .style('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                showEventModal(d);
            });
        
            // Store references for filtering
            window.yScale = yScale;
            window.yAxis = yAxis;
            window.svg = svg;
            window.eventLabels = eventLabels;
            window.getMatchingTags = getMatchingTags;
            window.lanePositions = lanePositions;
            window.categoryTags = categoryTags;
            
            // Update tag counts in filter UI
            updateTagCounts();
            
            // Apply initial period filters to hide unchecked periods
            applyPeriodFilters();
            
            // Apply initial tag filters
            applyTagFilters();
            
            // Update filter counts
            updateFilterCounts();
        }
        
        // Function to update tag counts in the filter UI
        function updateTagCounts() {
            if (!allEvents || !window.getMatchingTags) return;
            
            const tagCounts = {};
            categoryTags.forEach(tag => tagCounts[tag] = 0);
            
            allEvents.forEach(event => {
                const matchingTags = window.getMatchingTags(event);
                matchingTags.forEach(tag => {
                    if (tagCounts.hasOwnProperty(tag)) {
                        tagCounts[tag]++;
                    }
                });
            });
            
            // Update the UI
            Object.keys(tagCounts).forEach(tag => {
                const countElement = document.querySelector(`.tag-count[data-tag="${tag}"]`);
                if (countElement) {
                    countElement.textContent = `(${tagCounts[tag]})`;
                    countElement.style.color = '#6e7681';
                    countElement.style.fontSize = '0.9em';
                }
            });
        }
        
        // Filter functions
        function getEventPeriod(date) {
            const year = date.getFullYear();
            
            // Ancient: BCE to 999 CE (mapped to years 1-1999)
            if (year < 2000) return 'ancient';
            
            // Return the year as a string for exact matching
            return year.toString();
        }
        
        function matchesPeriodFilter(eventYear, filterValue) {
            // Ancient filter
            if (filterValue === 'ancient') {
                return eventYear < 2000;
            }
            
            // Exact year match (2010-2025)
            if (filterValue.length === 4) {
                return eventYear.toString() === filterValue;
            }
            
            // Decade match (194, 195, 196, 197, 198, 199, 200)
            if (filterValue.length === 3) {
                return eventYear.toString().startsWith(filterValue);
            }
            
            // Century match (18)
            if (filterValue.length === 2) {
                return eventYear.toString().startsWith(filterValue);
            }
            
            return false;
        }
        
        function applyPeriodFilters() {
            if (!window.nodes) return;
            
            // Get selected periods
            const selectedPeriods = Array.from(document.querySelectorAll('.period-filter:checked'))
                .map(cb => cb.value);
            
            // If no periods selected, hide all events
            const hideAll = selectedPeriods.length === 0;
            
            // Track visible events for date range calculation
            const visibleEvents = [];
            
            // Apply period filters to all events
            window.nodes.each(function(d) {
                const node = d3.select(this);
                let shouldShow = false;
                
                if (!hideAll) {
                    const eventYear = d.date.getFullYear();
                    shouldShow = selectedPeriods.some(p => matchesPeriodFilter(eventYear, p));
                }
                
                node.style('display', shouldShow ? 'block' : 'none');
                if (shouldShow) {
                    visibleEvents.push(d);
                }
            });
            
            // Also hide/show event labels
            if (window.eventLabels) {
                window.eventLabels.style('display', function(d) {
                    if (hideAll) return 'none';
                    const eventYear = d.date.getFullYear();
                    const shouldShow = selectedPeriods.some(p => matchesPeriodFilter(eventYear, p));
                    return shouldShow ? 'block' : 'none';
                });
            }
            
            // Update date range based on visible events - vertical
            if (visibleEvents.length > 0 && window.yScale && window.yAxis && window.svg) {
                const dates = visibleEvents.map(d => d.date);
                const minDate = d3.min(dates);
                const maxDate = d3.max(dates);
                
                // Add padding (10% on each side)
                const dateRange = maxDate - minDate;
                const paddedMin = new Date(minDate.getTime() - dateRange * 0.1);
                const paddedMax = new Date(maxDate.getTime() + dateRange * 0.1);
                
                // Update scale domain
                window.yScale.domain([paddedMin, paddedMax]);
                
                // Redraw axis and reposition nodes
                window.svg.select('.y-axis')
                    .transition()
                    .duration(500)
                    .call(window.yAxis);
                
                window.nodes
                    .transition()
                    .duration(500)
                    .attr('transform', function(d) {
                        const currentTransform = d3.select(this).attr('transform');
                        const xMatch = currentTransform.match(/translate\(([^,]+)/);
                        const x = xMatch ? xMatch[1] : 0;
                        return `translate(${x},${window.yScale(d.date)})`;
                    });
                
                window.svg.selectAll('.event-label')
                    .transition()
                    .duration(500)
                    .attr('y', d => window.yScale(d.date));
            }
        }
        
        function selectAllPeriods() {
            document.querySelectorAll('.period-filter').forEach(cb => cb.checked = true);
            applyPeriodFilters();
        }
        
        function deselectAllPeriods() {
            document.querySelectorAll('.period-filter').forEach(cb => cb.checked = false);
            applyPeriodFilters();
        }
        
        // Tag filter functions
        function selectAllTags() {
            document.querySelectorAll('.tag-filter').forEach(cb => cb.checked = true);
            applyTagFilters();
        }
        
        function deselectAllTags() {
            document.querySelectorAll('.tag-filter').forEach(cb => cb.checked = false);
            applyTagFilters();
        }
        
        // Content filter function
        async function applyContentFilters() {
            if (!window.nodes) return;
            
            const photoFilterChecked = document.getElementById('photoFilter').checked;
            
            if (!photoFilterChecked) {
                // No content filter active, show all and apply tag filters normally
                window.nodes.each(function(d) {
                    if (d.type === 'chronology') {
                        const node = d3.select(this);
                        const label = window.svg.selectAll('.event-label')
                            .filter(labelData => labelData === d);
                        node.style('display', null);
                        label.style('display', null);
                    }
                });
                applyTagFilters();
                return;
            }
            
            // Load chronology data to check for photos
            const data = await loadChronologyData();
            
            if (!data) {
                console.error('Could not load chronology data for photo filter');
                return;
            }
            
            // First pass: apply photo filter
            window.nodes.each(function(d) {
                if (d.type !== 'chronology') {
                    return;
                }
                
                const node = d3.select(this);
                const label = window.svg.selectAll('.event-label')
                    .filter(labelData => labelData === d);
                
                // Find entry in chronology data
                const entry = data.find(e => e.title.trim() === d.title.trim());
                const hasPhotos = entry && entry.images && entry.images.length > 0;
                
                if (hasPhotos) {
                    node.style('display', null);
                    label.style('display', null);
                    // Mark as having photos for tag filter
                    d._hasPhotos = true;
                } else {
                    node.style('display', 'none');
                    label.style('display', 'none');
                    d._hasPhotos = false;
                }
            });
            
            // Second pass: apply tag filters only to events with photos
            applyTagFilters();
        }
        
        function applyTagFilters() {
            if (!window.nodes) return;
            
            // Get selected tags
            const selectedTags = Array.from(document.querySelectorAll('.tag-filter:checked'))
                .map(cb => cb.value);
            
            // Get total number of tag filters
            const totalTags = document.querySelectorAll('.tag-filter').length;
            
            // If all tags selected, show all events
            // If no tags selected, hide all events
            const showAll = selectedTags.length === totalTags;
            const hideAll = selectedTags.length === 0;
            
            // Check if photo filter is active
            const photoFilterChecked = document.getElementById('photoFilter') ? 
                document.getElementById('photoFilter').checked : false;
            
            // Filter nodes based on tags
            window.nodes.each(function(d) {
                const node = d3.select(this);
                const label = window.svg.selectAll('.event-label')
                    .filter(labelData => labelData === d);
                
                // Skip if already hidden by photo filter
                if (photoFilterChecked && node.style('display') === 'none') {
                    return;
                }
                
                if (hideAll) {
                    // Hide all events when no tags selected
                    node.style('display', 'none');
                    label.style('display', 'none');
                } else if (showAll) {
                    // Show all events (unless hidden by photo filter)
                    if (!photoFilterChecked) {
                        node.style('display', null);
                        label.style('display', null);
                    }
                } else {
                    // Check if event has any of the selected tags (exact match, case-insensitive)
                    const eventTags = d.tags || [];
                    const hasMatchingTag = selectedTags.some(tag => 
                        eventTags.some(eventTag => 
                            eventTag.toLowerCase() === tag.toLowerCase()
                        )
                    );
                    
                    if (hasMatchingTag) {
                        node.style('display', null);
                        label.style('display', null);
                    } else {
                        node.style('display', 'none');
                        label.style('display', 'none');
                    }
                }
            });
            
            updateFilterCounts(); // Update counts after filtering
        }
        
        // Function to calculate and update filter counts based on currently visible events
        async function updateFilterCounts() {
            if (!window.nodes) return;
            
            const counts = {
                periods: {},
                tags: {},
                withPhotos: 0
            };
            
            // Count only visible events
            window.nodes.each(function(d) {
                if (d.type !== 'chronology') return;
                
                const node = d3.select(this);
                const isVisible = node.style('display') !== 'none';
                
                if (!isVisible) return;
                
                const event = d;
                const year = event.date.getFullYear();
                const yearStr = year.toString();
                
                // Period filters
                if (year >= 2026) counts.periods['2026'] = (counts.periods['2026'] || 0) + 1;
                else if (year >= 2025) counts.periods['2025'] = (counts.periods['2025'] || 0) + 1;
                else if (year >= 2024) counts.periods['2024'] = (counts.periods['2024'] || 0) + 1;
                else if (year >= 2023) counts.periods['2023'] = (counts.periods['2023'] || 0) + 1;
                else if (year >= 2022) counts.periods['2022'] = (counts.periods['2022'] || 0) + 1;
                else if (year >= 2021) counts.periods['2021'] = (counts.periods['2021'] || 0) + 1;
                else if (year >= 2020) counts.periods['2020'] = (counts.periods['2020'] || 0) + 1;
                else if (year >= 2019) counts.periods['2019'] = (counts.periods['2019'] || 0) + 1;
                else if (year >= 2018) counts.periods['2018'] = (counts.periods['2018'] || 0) + 1;
                else if (year >= 2017) counts.periods['2017'] = (counts.periods['2017'] || 0) + 1;
                else if (year >= 2016) counts.periods['2016'] = (counts.periods['2016'] || 0) + 1;
                else if (year >= 2015) counts.periods['2015'] = (counts.periods['2015'] || 0) + 1;
                else if (year >= 2014) counts.periods['2014'] = (counts.periods['2014'] || 0) + 1;
                else if (year >= 2013) counts.periods['2013'] = (counts.periods['2013'] || 0) + 1;
                else if (year >= 2012) counts.periods['2012'] = (counts.periods['2012'] || 0) + 1;
                else if (year >= 2011) counts.periods['2011'] = (counts.periods['2011'] || 0) + 1;
                else if (year >= 2010) counts.periods['2010'] = (counts.periods['2010'] || 0) + 1;
                else if (yearStr.startsWith('200')) counts.periods['200'] = (counts.periods['200'] || 0) + 1;
                else if (yearStr.startsWith('199')) counts.periods['199'] = (counts.periods['199'] || 0) + 1;
                else if (yearStr.startsWith('198')) counts.periods['198'] = (counts.periods['198'] || 0) + 1;
                else if (yearStr.startsWith('197')) counts.periods['197'] = (counts.periods['197'] || 0) + 1;
                else if (yearStr.startsWith('196')) counts.periods['196'] = (counts.periods['196'] || 0) + 1;
                else if (yearStr.startsWith('195')) counts.periods['195'] = (counts.periods['195'] || 0) + 1;
                else if (yearStr.startsWith('194')) counts.periods['194'] = (counts.periods['194'] || 0) + 1;
                else if (yearStr.startsWith('18')) counts.periods['18'] = (counts.periods['18'] || 0) + 1;
                else if (year < 1800) counts.periods['ancient'] = (counts.periods['ancient'] || 0) + 1;
                
                // Count by tags
                if (event.tags && event.tags.length > 0) {
                    event.tags.forEach(tag => {
                        const tagClean = tag.replace('#', '');
                        if (tagClean.includes('LegislationPolicy')) counts.tags['LegislationPolicy'] = (counts.tags['LegislationPolicy'] || 0) + 1;
                        if (tagClean.includes('CongressionalHearings')) counts.tags['CongressionalHearings'] = (counts.tags['CongressionalHearings'] || 0) + 1;
                        if (tagClean.includes('LeaksDeclass')) counts.tags['LeaksDeclass'] = (counts.tags['LeaksDeclass'] || 0) + 1;
                        if (tagClean.includes('WhistleblowerDisclosures')) counts.tags['WhistleblowerDisclosures'] = (counts.tags['WhistleblowerDisclosures'] || 0) + 1;
                        if (tagClean.includes('MilitaryEncounters')) counts.tags['MilitaryEncounters'] = (counts.tags['MilitaryEncounters'] || 0) + 1;
                        if (tagClean.includes('CivilianSightings')) counts.tags['CivilianSightings'] = (counts.tags['CivilianSightings'] || 0) + 1;
                        if (tagClean.includes('AbductionCEIII')) counts.tags['AbductionCEIII'] = (counts.tags['AbductionCEIII'] || 0) + 1;
                        if (tagClean.includes('CrashRetrievals')) counts.tags['CrashRetrievals'] = (counts.tags['CrashRetrievals'] || 0) + 1;
                        if (tagClean.includes('UnderwaterUSO')) counts.tags['UnderwaterUSO'] = (counts.tags['UnderwaterUSO'] || 0) + 1;
                        if (tagClean.includes('SpaceSatellite')) counts.tags['SpaceSatellite'] = (counts.tags['SpaceSatellite'] || 0) + 1;
                        if (tagClean.includes('ScientificStudies')) counts.tags['ScientificStudies'] = (counts.tags['ScientificStudies'] || 0) + 1;
                        if (tagClean.includes('HistoricalPreModern')) counts.tags['HistoricalPreModern'] = (counts.tags['HistoricalPreModern'] || 0) + 1;
                        if (tagClean.includes('ReligiousCultural')) counts.tags['ReligiousCultural'] = (counts.tags['ReligiousCultural'] || 0) + 1;
                    });
                }
            });
            
            // Update period filter counts
            Object.keys(counts.periods).forEach(period => {
                const checkbox = document.querySelector(`.period-filter[value="${period}"]`);
                if (checkbox) {
                    const label = checkbox.parentElement;
                    const span = label.querySelector('span');
                    const currentText = span.textContent.replace(/\s*\(\d+\)/, '');
                    span.textContent = `${currentText} (${counts.periods[period]})`;
                }
            });
            
            // Update tag filter counts
            Object.keys(counts.tags).forEach(tag => {
                const checkbox = document.querySelector(`.tag-filter[value="${tag}"]`);
                if (checkbox) {
                    const label = checkbox.parentElement;
                    const span = label.querySelector('span');
                    const currentText = span.textContent.replace(/\s*\(\d+\)/, '');
                    span.textContent = `${currentText} (${counts.tags[tag]})`;
                }
            });
            
            // Count visible events with photos
            const data = await loadChronologyData();
            if (data) {
                let withPhotosCount = 0;
                window.nodes.each(function(d) {
                    if (d.type !== 'chronology') return;
                    
                    const node = d3.select(this);
                    const isVisible = node.style('display') !== 'none';
                    
                    if (!isVisible) return;
                    
                    // Find entry in chronology data
                    const entry = data.find(e => e.title.trim() === d.title.trim());
                    if (entry && entry.images && entry.images.length > 0) {
                        withPhotosCount++;
                    }
                });
                
                const photoFilterLabel = document.querySelector('#photoFilter').parentElement;
                const span = photoFilterLabel.querySelector('span');
                const currentText = span.textContent.replace(/\s*\(\d+\)/, '');
                span.textContent = `${currentText} (${withPhotosCount})`;
            }
        }
        
        // Modal functions
        let chronologyData = null;
        
        async function loadChronologyData() {
            if (chronologyData) return chronologyData;
            
            try {
                const response = await fetch('dist/chronology.md');
                const text = await response.text();
                chronologyData = parseChronologyData(text);
                return chronologyData;
            } catch (error) {
                console.error('Error loading chronology data:', error);
                return null;
            }
        }
        
        function parseChronologyData(text) {
            const lines = text.split('\n');
            const entries = [];
            let currentEntry = null;
            let currentSection = 'summary';
            
            for (let line of lines) {
                line = line.trim();
                
                const headerMatch = line.match(/^##\s+(\d{1,4}(?:\s+(?:BCE|CE))?(?:,\s+[A-Za-z]+(?:\s+\d{1,2})?)?)\s+-\s+(.+)/i);
                
                if (headerMatch) {
                    if (currentEntry) entries.push(currentEntry);
                    
                    // Extract title and tags from header
                    const titleAndTags = headerMatch[2];
                    const tags = [];
                    const tagMatches = titleAndTags.match(/#\w+/g);
                    if (tagMatches) {
                        tags.push(...tagMatches);
                    }
                    const title = titleAndTags.replace(/#\w+/g, '').trim();
                    
                    currentEntry = {
                        date: headerMatch[1],
                        title: title,
                        content: '',
                        images: [],
                        links: [],
                        tags: tags,
                        details: ''
                    };
                    currentSection = 'summary';
                } else if (currentEntry) {
                    // Track which section we're in
                    if (line === '**Links:**') {
                        currentSection = 'links';
                        continue;
                    } else if (line === '**Photos:**') {
                        currentSection = 'photos';
                        continue;
                    } else if (line === '**Details:**') {
                        currentSection = 'details';
                        continue;
                    }
                    
                    // Skip separators and empty lines
                    if (line === '\\' || line === '') {
                        continue;
                    }
                    
                    // Parse based on current section
                    if (currentSection === 'links') {
                        // Parse markdown links [text](url)
                        const mdLinkMatch = line.match(/\[([^\]]+)\]\(([^)]+)\)/);
                        if (mdLinkMatch) {
                            const linkText = mdLinkMatch[1];
                            const linkUrl = mdLinkMatch[2];
                            // If text is a URL, extract domain for display
                            const displayText = linkText.startsWith('http') ? 
                                linkText.replace(/^https?:\/\//, '').split('/')[0] : 
                                linkText;
                            currentEntry.links.push({text: displayText, url: linkUrl});
                        } else if (line.startsWith('http://') || line.startsWith('https://')) {
                            // Plain URL
                            const displayText = line.replace(/^https?:\/\//, '').split('/')[0];
                            currentEntry.links.push({text: displayText, url: line});
                        }
                    } else if (currentSection === 'photos') {
                        // Parse images
                        const imgMatch = line.match(/!\[([^\]]*)\]\(([^)]+)\)/);
                        if (imgMatch) {
                            currentEntry.images.push({alt: imgMatch[1], src: imgMatch[2]});
                        }
                    } else if (currentSection === 'details') {
                        // Add to details
                        currentEntry.details += (currentEntry.details ? '\n' : '') + line;
                    } else if (currentSection === 'summary') {
                        // Add to summary content
                        currentEntry.content += (currentEntry.content ? '\n' : '') + line;
                    }
                }
            }
            
            if (currentEntry) entries.push(currentEntry);
            return entries;
        }
        
        async function showEventModal(eventData) {
            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDate = document.getElementById('modalDate');
            const modalBody = document.getElementById('modalBody');
            const modalLinks = document.getElementById('modalLinks');
            const modalTags = document.getElementById('modalTags');
            
            // Set basic info
            modalTitle.textContent = eventData.title;
            
            // Format date
            let dateStr;
            if (eventData.originalDateStr) {
                if (eventData.originalDateStr.match(/BCE|CE/i)) {
                    dateStr = eventData.originalDateStr;
                } else {
                    const yearMatch = eventData.originalDateStr.match(/^(\d{4})/);
                    if (yearMatch) {
                        const year = yearMatch[1];
                        const monthMatch = eventData.originalDateStr.match(/,\s+([A-Za-z]+)(?:\s+(\d{1,2}))?/);
                        if (monthMatch) {
                            const month = monthMatch[1];
                            const day = monthMatch[2] || '1';
                            dateStr = `${month} ${day}, ${year}`;
                        } else {
                            dateStr = year;
                        }
                    } else {
                        dateStr = eventData.originalDateStr;
                    }
                }
            } else {
                dateStr = d3.timeFormat('%B %d, %Y')(eventData.date);
            }
            modalDate.textContent = dateStr;
            
            // For chronology events, load full content
            if (eventData.type === 'chronology') {
                const data = await loadChronologyData();
                if (data) {
                    // Match by title (eventData.title already has tags stripped)
                    const entry = data.find(e => e.title.trim() === eventData.title.trim());
                    if (entry) {
                        console.log('Found entry:', entry.title);
                        console.log('Images:', entry.images);
                        
                        let bodyHtml = '';
                        
                        // Add summary content
                        if (entry.content) {
                            let content = entry.content;
                            content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                            content = content.replace(/\n/g, '<br>');
                            bodyHtml += `<div style="margin-bottom: 20px;">${content}</div>`;
                        }
                        
                        // Add photos section
                        if (entry.images && entry.images.length > 0) {
                            console.log('Rendering images:', entry.images);
                            bodyHtml += '<div style="margin-bottom: 20px;"><strong style="color: #58a6ff;">Photos:</strong><div style="margin-top: 10px;">';
                            entry.images.forEach(img => {
                                // Ensure path is correct - add dist/ prefix if not present
                                const imgSrc = img.src.startsWith('dist/') ? img.src : `dist/${img.src}`;
                                console.log('Image src:', imgSrc);
                                bodyHtml += `<img src="${imgSrc}" alt="${img.alt}" loading="lazy" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 6px; border: 1px solid #30363d; display: block;" onerror="console.error('Failed to load image:', this.src)">`;
                            });
                            bodyHtml += '</div></div>';
                        }
                        
                        // Add details section
                        if (entry.details) {
                            let details = entry.details;
                            details = details.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                            details = details.replace(/\n/g, '<br>');
                            bodyHtml += `<div style="margin-bottom: 20px;"><strong style="color: #58a6ff;">Details:</strong><div style="margin-top: 10px;">${details}</div></div>`;
                        }
                        
                        modalBody.innerHTML = bodyHtml;
                        
                        // Add links section
                        if (entry.links.length > 0) {
                            modalLinks.innerHTML = '<div style="color: #58a6ff; font-weight: bold; margin-bottom: 10px;">Links:</div>' +
                                entry.links.map(link => 
                                    `<div style="margin: 5px 0;"><a href="${link.url}" target="_blank" style="color: #58a6ff; text-decoration: none; word-break: break-all;">${link.text}</a></div>`
                                ).join('');
                        } else {
                            modalLinks.innerHTML = '';
                        }
                        
                        // Add tags
                        if (entry.tags.length > 0) {
                            modalTags.innerHTML = entry.tags.map(tag => 
                                `<span class="modal-tag">${tag}</span>`
                            ).join('');
                        } else {
                            modalTags.innerHTML = '';
                        }
                    } else {
                        modalBody.textContent = eventData.description;
                        modalLinks.innerHTML = '';
                        modalTags.innerHTML = '';
                    }
                } else {
                    modalBody.textContent = eventData.description;
                    modalLinks.innerHTML = '';
                    modalTags.innerHTML = '';
                }
            } else {
                // Communication events
                modalBody.textContent = eventData.description;
                modalLinks.innerHTML = '';
                modalTags.innerHTML = '';
            }
            
            modal.classList.add('visible');
        }
        
        function closeModal() {
            const modal = document.getElementById('eventModal');
            modal.classList.remove('visible');
        }
        
        // Close modal when clicking outside
        document.getElementById('eventModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        function resetZoom() {
            if (allEvents.length === 0) return;
            const dates = allEvents.map(d => d.date);
            const minDate = d3.min(dates);
            const maxDate = d3.max(dates);
            
            // Add padding
            const dateRange = maxDate - minDate;
            const paddedMin = new Date(minDate.getTime() - dateRange * 0.05);
            const paddedMax = new Date(maxDate.getTime() + dateRange * 0.05);
            
            if (window.yScale) {
                window.yScale.domain([paddedMin, paddedMax]);
                updateTimeline();
            }
        }
        
        function updateButtons() {
            d3.selectAll('.btn').classed('active', false);
            if (currentFilter === 'all') {
                d3.selectAll('.btn').filter(function() { return this.textContent === 'ALL EVENTS'; }).classed('active', true);
            } else if (currentFilter === 'outbound') {
                d3.selectAll('.btn').filter(function() { return this.textContent === 'OUTBOUND ONLY'; }).classed('active', true);
            } else if (currentFilter === 'inbound') {
                d3.selectAll('.btn').filter(function() { return this.textContent === 'INBOUND ONLY'; }).classed('active', true);
            } else if (currentFilter === 'chronology') {
                d3.selectAll('.btn').filter(function() { return this.textContent === 'CHRONOLOGY'; }).classed('active', true);
            }
        }
        
        function updateTimeline() {
            if (window.svg && window.yAxis && window.yScale && window.nodes) {
                window.svg.select('.y-axis').call(window.yAxis);
                window.nodes.attr('transform', function(d) {
                    const currentTransform = d3.select(this).attr('transform');
                    const xMatch = currentTransform.match(/translate\(([^,]+)/);
                    const x = xMatch ? xMatch[1] : 0;
                    return `translate(${x},${window.yScale(d.date)})`;
                });
                window.svg.selectAll('.event-label').attr('y', d => window.yScale(d.date));
            }
        }
        
        function toggleSidebar(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
            
            // Persist state
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }
        
        // Restore sidebar state on load
        window.addEventListener('DOMContentLoaded', function() {
            // On mobile, start with sidebar collapsed by default
            const isMobile = window.innerWidth <= 768;
            const savedState = localStorage.getItem('sidebarCollapsed');
            const isCollapsed = savedState !== null ? savedState === 'true' : isMobile;
            
            if (isCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('toggleSidebar').classList.add('collapsed');
            }
        });
        
        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.style.display = 'block';
            }
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                    const installBtn = document.getElementById('installBtn');
                    if (installBtn) {
                        installBtn.style.display = 'none';
                    }
                });
            }
        }
        
        // Register service worker with cache busting
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js?v=20260103')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
        
        // Map view functionality
        let map = null;
        let markerClusterGroup = null;
        
        function showTimelineView() {
            document.getElementById('timeline').style.display = 'block';
            document.getElementById('mapView').style.display = 'none';
            document.getElementById('timelineViewBtn').classList.add('active');
            document.getElementById('mapViewBtn').classList.remove('active');
        }
        
        function showMapView() {
            document.getElementById('timeline').style.display = 'none';
            document.getElementById('mapView').style.display = 'block';
            document.getElementById('timelineViewBtn').classList.remove('active');
            document.getElementById('mapViewBtn').classList.add('active');
            
            if (!map) {
                initializeMap();
            }
        }
        
        function initializeMap() {
            // Initialize Leaflet map
            map = L.map('mapView', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxZoom: 18,
                worldCopyJump: true
            });
            
            // Add dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
            
            // Initialize marker cluster group
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 10) size = 'large';
                    else if (count > 5) size = 'medium';
                    
                    return L.divIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster marker-cluster-' + size,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            // Add markers for events with coordinates
            const eventsWithCoords = allEvents.filter(e => e.coordinates && e.coordinates[0] !== 0 && e.coordinates[1] !== 0);
            
            eventsWithCoords.forEach(event => {
                const [lat, lng] = event.coordinates;
                
                // Create custom icon based on event type
                let iconColor = '#8b949e';
                let iconShape = 'circle';
                
                if (event.type === 'outbound') {
                    iconColor = '#58a6ff';
                    iconShape = 'square';
                } else if (event.type === 'inbound') {
                    iconColor = '#f85149';
                    iconShape = 'triangle';
                } else if (event.type === 'contact-attempt') {
                    iconColor = '#a371f7';
                    iconShape = 'diamond';
                }
                
                // Create custom marker icon
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${iconColor}; width: 16px; height: 16px; border-radius: ${iconShape === 'circle' ? '50%' : iconShape === 'square' ? '2px' : '0'}; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); ${iconShape === 'triangle' ? 'transform: rotate(45deg);' : ''} ${iconShape === 'diamond' ? 'transform: rotate(45deg);' : ''}"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const marker = L.marker([lat, lng], { icon: markerIcon });
                
                // Format date for popup
                let dateStr;
                if (event.originalDateStr) {
                    if (event.originalDateStr.match(/BCE|CE/i)) {
                        dateStr = event.originalDateStr;
                    } else {
                        const yearMatch = event.originalDateStr.match(/^(\d{4})/);
                        if (yearMatch) {
                            const year = yearMatch[1];
                            const monthMatch = event.originalDateStr.match(/,\s+([A-Za-z]+)(?:\s+(\d{1,2}))?/);
                            if (monthMatch) {
                                const month = monthMatch[1];
                                const day = monthMatch[2] || '1';
                                dateStr = `${month} ${day}, ${year}`;
                            } else {
                                dateStr = year;
                            }
                        } else {
                            dateStr = event.originalDateStr;
                        }
                    }
                } else {
                    dateStr = d3.timeFormat('%B %d, %Y')(event.date);
                }
                
                // Create popup content
                const popupContent = `
                    <div class="map-popup-title">${event.title}</div>
                    <div class="map-popup-date">${dateStr}</div>
                    ${event.location ? `<div style="color: #8b949e; font-size: 0.8em; margin-bottom: 8px;">üìç ${event.location}</div>` : ''}
                    <div class="map-popup-description">${event.description}</div>
                    <a class="map-popup-link" onclick="showEventModal(${JSON.stringify(event).replace(/"/g, '&quot;')})">View Details ‚Üí</a>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });
                
                markerClusterGroup.addLayer(marker);
            });
            
            map.addLayer(markerClusterGroup);
            
            // Add legend to map
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'map-legend');
                div.style.background = '#161b22';
                div.style.padding = '10px';
                div.style.borderRadius = '6px';
                div.style.border = '1px solid #30363d';
                div.style.color = '#c9d1d9';
                div.style.fontFamily = 'Share Tech Mono, monospace';
                div.style.fontSize = '0.85em';
                
                div.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; color: #58a6ff;">Event Types</div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <div style="width: 12px; height: 12px; background: #58a6ff; border-radius: 2px; border: 2px solid #fff;"></div>
                        <span>Outbound</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <div style="width: 12px; height: 12px; background: #f85149; transform: rotate(45deg); border: 2px solid #fff;"></div>
                        <span>Inbound</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #a371f7; transform: rotate(45deg); border: 2px solid #fff;"></div>
                        <span>Contact Attempt</span>
                    </div>
                `;
                
                return div;
            };
            legend.addTo(map);
            
            console.log(`Map initialized with ${eventsWithCoords.length} geotagged events`);
        }
        
        // Initialize language switcher
        document.getElementById('languageSwitcherContainer').innerHTML = createLanguageSwitcher();
        updatePageLanguage();
    </script>
</body>
</html>
